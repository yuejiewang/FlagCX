// include XPU-related headers
#include "flagcx.h"
#include "launch_kernel.h"

__global__ void asyncKernel(int *__restrict__ values) {
  volatile int *signals = values;
  // set all ops curStep to 0
  for (int i = 0; i < FLAGCX_OPS_PER_SEMAPHORE; ++i) {
    signals[i] = 0;
  }
  mfence(); // Ensure that the write is visible to the CPU.
  while (signals[FLAGCX_SIGNAL_COUNTER_OFFSET] > 0) {
    // busy-wait
  }
  mfence(); // Ensure that the write is visible to the CPU.
}

extern "C" void deviceAsyncKernel(flagcxStream_t stream, void *args) {
  int *signals = static_cast<int *>(args);
  asyncKernel<<<1, 1, *(XPUStream *)stream>>>(signals);
  return;
}